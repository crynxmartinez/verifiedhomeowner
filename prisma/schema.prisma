// Verified Homeowner - Prisma Schema
// Migrated from Supabase PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS
// ============================================================================

model User {
  id                    String    @id @default(uuid()) @db.Uuid
  email                 String    @unique @db.VarChar(255)
  password              String    @db.VarChar(255)
  name                  String    @db.VarChar(255)
  role                  UserRole  @default(wholesaler)
  planType              PlanType  @default(free) @map("plan_type")
  subscriptionStatus    SubscriptionStatus @default(active) @map("subscription_status")
  leadSequencePosition  Int       @default(0) @map("lead_sequence_position")
  
  // Email Verification
  emailVerified         Boolean   @default(false) @map("email_verified")
  verificationToken     String?   @map("verification_token")
  verificationExpires   DateTime? @map("verification_expires") @db.Timestamptz
  
  // Password Reset
  resetToken            String?   @map("reset_token")
  resetTokenExpires     DateTime? @map("reset_token_expires") @db.Timestamptz
  
  // Dodo Payments
  dodoSubscriptionId    String?   @map("dodo_subscription_id")
  dodoCustomerId        String?   @map("dodo_customer_id")
  subscriptionEndDate   DateTime? @map("subscription_end_date") @db.Timestamptz
  
  // Trial Tracking
  hasUsedTrial          Boolean   @default(false) @map("has_used_trial")
  trialUsedAt           DateTime? @map("trial_used_at") @db.Timestamptz
  
  // Marketplace Preferences
  preferredStates       String[]  @default([]) @map("preferred_states")
  marketplaceEmails     Boolean   @default(true) @map("marketplace_emails")
  lastLoginAt           DateTime? @map("last_login_at") @db.Timestamptz
  
  // Email Tracking
  lastEmailSentAt       DateTime? @map("last_email_sent_at") @db.Timestamptz
  lastEmailType         String?   @map("last_email_type") @db.VarChar(100)
  
  // Timestamps
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  userLeads             UserLead[]
  userMarketplaceLeads  UserMarketplaceLead[]
  supportTickets        SupportTicket[]
  notificationQueue     MarketplaceNotificationQueue[]

  @@index([email])
  @@index([role])
  @@index([planType])
  @@index([createdAt(sort: Desc)])
  @@index([verificationToken])
  @@index([resetToken])
  @@map("users")
}

enum UserRole {
  admin
  wholesaler
}

enum PlanType {
  free
  basic
  elite
  pro
}

enum SubscriptionStatus {
  active
  inactive
  cancelled
  expired
  on_hold
}

// ============================================================================
// LEADS (Master Lead Database)
// ============================================================================

model Lead {
  id              String    @id @default(uuid()) @db.Uuid
  firstName       String?   @map("first_name") @db.VarChar(255)
  lastName        String?   @map("last_name") @db.VarChar(255)
  fullName        String?   @map("full_name") @db.VarChar(255)
  isBusiness      Boolean   @default(false) @map("is_business")
  phone           String?   @db.VarChar(50)
  propertyAddress String?   @map("property_address") @db.VarChar(500)
  city            String?   @db.VarChar(255)
  state           String?   @db.VarChar(100)
  zipCode         String?   @map("zip_code") @db.VarChar(20)
  mailingAddress  String?   @map("mailing_address") @db.VarChar(500)
  mailingCity     String?   @map("mailing_city") @db.VarChar(255)
  mailingState    String?   @map("mailing_state") @db.VarChar(100)
  mailingZip      String?   @map("mailing_zip") @db.VarChar(20)
  sequenceNumber  Int       @unique @map("sequence_number")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  userLeads       UserLead[]

  @@index([sequenceNumber])
  @@index([propertyAddress])
  @@map("leads")
}

// ============================================================================
// USER LEADS (Assigned Subscription Leads)
// ============================================================================

model UserLead {
  id            String      @id @default(uuid()) @db.Uuid
  userId        String      @map("user_id") @db.Uuid
  leadId        String      @map("lead_id") @db.Uuid
  status        LeadStatus  @default(new)
  action        LeadAction  @default(call_now)
  motivation    String?     @db.VarChar(100)
  assignedAt    DateTime    @default(now()) @map("assigned_at")
  lastCalledAt  DateTime?   @map("last_called_at")
  followUpDate  DateTime?   @map("follow_up_date") @db.Date
  countdownDays Int?        @map("countdown_days")
  notes         String?
  tags          String[]    @default([])
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead          Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([userId, leadId])
  @@index([userId])
  @@index([status])
  @@index([action])
  @@index([assignedAt(sort: Desc)])
  @@index([followUpDate])
  @@map("user_leads")
}

enum LeadStatus {
  new
  follow_up
  not_interested
  pending
}

enum LeadAction {
  call_now
  pending
}

// ============================================================================
// MARKETPLACE LEADS (Hot Leads for Purchase)
// ============================================================================

model MarketplaceLead {
  id              String    @id @default(uuid()) @db.Uuid
  ownerName       String?   @map("owner_name") @db.VarChar(255)
  phone           String?   @db.VarChar(50)
  propertyAddress String?   @map("property_address") @db.VarChar(500)
  city            String?   @db.VarChar(255)
  state           String?   @db.VarChar(100)
  zipCode         String?   @map("zip_code") @db.VarChar(20)
  mailingAddress  String?   @map("mailing_address") @db.VarChar(500)
  mailingCity     String?   @map("mailing_city") @db.VarChar(255)
  mailingState    String?   @map("mailing_state") @db.VarChar(100)
  mailingZip      String?   @map("mailing_zip") @db.VarChar(20)
  motivation      String    @db.VarChar(100)
  timeline        String    @db.VarChar(100)
  askingPrice     Decimal?  @map("asking_price") @db.Decimal(12, 2)
  temperature     String?   @default("warm") @db.VarChar(20)
  price           Decimal   @db.Decimal(10, 2)
  maxBuyers       Int       @default(0) @map("max_buyers")
  timesSold       Int       @default(0) @map("times_sold")
  isHidden        Boolean   @default(false) @map("is_hidden")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  userMarketplaceLeads UserMarketplaceLead[]
  notificationQueue    MarketplaceNotificationQueue[]

  @@index([state])
  @@index([motivation])
  @@index([timeline])
  @@index([createdAt(sort: Desc)])
  @@index([price])
  @@map("marketplace_leads")
}

// ============================================================================
// USER MARKETPLACE LEADS (Purchased Hot Leads)
// ============================================================================

model UserMarketplaceLead {
  id                String          @id @default(uuid()) @db.Uuid
  userId            String          @map("user_id") @db.Uuid
  marketplaceLeadId String          @map("marketplace_lead_id") @db.Uuid
  purchasedAt       DateTime        @default(now()) @map("purchased_at")
  pricePaid         Decimal         @map("price_paid") @db.Decimal(10, 2)
  status            LeadStatus      @default(new)
  action            LeadAction      @default(call_now)
  lastCalledAt      DateTime?       @map("last_called_at")
  followUpDate      DateTime?       @map("follow_up_date") @db.Date
  countdownDays     Int?            @map("countdown_days")
  notes             String?
  tags              String[]        @default([])
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  marketplaceLead   MarketplaceLead @relation(fields: [marketplaceLeadId], references: [id], onDelete: Cascade)

  @@unique([userId, marketplaceLeadId])
  @@index([userId])
  @@index([status])
  @@index([purchasedAt(sort: Desc)])
  @@map("user_marketplace_leads")
}

// ============================================================================
// SUPPORT TICKETS
// ============================================================================

model SupportTicket {
  id        String       @id @default(uuid()) @db.Uuid
  userId    String?      @map("user_id") @db.Uuid
  name      String       @db.VarChar(255)
  email     String       @db.VarChar(255)
  category  String       @db.VarChar(100)
  message   String
  status    TicketStatus @default(open)
  createdAt DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user      User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("support_tickets")
}

enum TicketStatus {
  open
  resolved
}

// ============================================================================
// EMAIL AUTOMATION SYSTEM
// ============================================================================

model EmailTemplate {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique @db.VarChar(100)
  displayName String   @map("display_name") @db.VarChar(255)
  subject     String   @db.VarChar(500)
  htmlContent String   @map("html_content") @db.Text
  textContent String   @map("text_content") @db.Text
  variables   String[] @default([])
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  automations EmailAutomation[]

  @@index([name])
  @@index([isActive])
  @@map("email_templates")
}

model EmailAutomation {
  id                  String    @id @default(uuid()) @db.Uuid
  name                String    @db.VarChar(255)
  description         String?   @db.VarChar(500)
  templateId          String    @map("template_id") @db.Uuid
  trigger             String    @db.VarChar(100)
  delayHours          Int       @default(0) @map("delay_hours")
  repeatIntervalHours Int       @default(0) @map("repeat_interval_hours")
  maxSends            Int       @default(1) @map("max_sends")
  isActive            Boolean   @default(true) @map("is_active")
  totalSent           Int       @default(0) @map("total_sent")
  lastRunAt           DateTime? @map("last_run_at") @db.Timestamptz
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  template            EmailTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  emailLogs           EmailLog[]

  @@index([trigger])
  @@index([isActive])
  @@map("email_automations")
}

model EmailLog {
  id             String    @id @default(uuid()) @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  automationId   String?   @map("automation_id") @db.Uuid
  templateName   String    @map("template_name") @db.VarChar(100)
  subject        String    @db.VarChar(500)
  recipientEmail String    @map("recipient_email") @db.VarChar(255)
  status         String    @default("sent") @db.VarChar(50)
  sentAt         DateTime  @default(now()) @map("sent_at") @db.Timestamptz

  // Relations
  automation     EmailAutomation? @relation(fields: [automationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([automationId])
  @@index([templateName])
  @@index([sentAt(sort: Desc)])
  @@map("email_logs")
}

// ============================================================================
// MARKETPLACE NOTIFICATION QUEUE (for delayed notifications by plan tier)
// ============================================================================

model MarketplaceNotificationQueue {
  id                String    @id @default(uuid()) @db.Uuid
  userId            String    @map("user_id") @db.Uuid
  marketplaceLeadId String    @map("marketplace_lead_id") @db.Uuid
  scheduledFor      DateTime  @map("scheduled_for") @db.Timestamptz
  status            String    @default("pending") @db.VarChar(50) // pending, sent, cancelled
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz
  sentAt            DateTime? @map("sent_at") @db.Timestamptz

  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  marketplaceLead   MarketplaceLead @relation(fields: [marketplaceLeadId], references: [id], onDelete: Cascade)

  @@index([scheduledFor])
  @@index([status])
  @@index([userId])
  @@index([marketplaceLeadId])
  @@map("marketplace_notification_queue")
}
